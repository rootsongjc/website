<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg version="1.1" xmlns:xl="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" xmlns:dc="http://purl.org/dc/elements/1.1/" viewBox="453 -794 1240 950" width="1240" height="950">
  <defs>
    <marker orient="auto" overflow="visible" markerUnits="strokeWidth" id="FilledArrow_Marker" stroke-linejoin="miter" stroke-miterlimit="10" viewBox="-1 -4 10 8" markerWidth="10" markerHeight="8" color="black">
      <g>
        <path d="M 8 0 L 0 -3 L 0 3 Z" fill="currentColor" stroke="currentColor" stroke-width="1"/>
      </g>
    </marker>
  </defs>
  <g id="Ambient_mesh____ztunnel_L4______" stroke="none" stroke-opacity="1" fill-opacity="1" stroke-dasharray="none" fill="none">
    <title>Ambient mesh 模式 ztunnel L4 流量处理路径</title>
    <rect fill="white" x="453" y="-794" width="1240" height="950"/>
    <g id="Ambient_mesh____ztunnel_L4_______Layer_1">
      <title>Layer 1</title>
      <g id="Graphic_140">
        <rect x="453.5324" y="-793.9567" width="1239" height="949" fill="white"/>
      </g>
      <g id="Graphic_139">
        <rect x="1111.4646" y="-773" width="566.92914" height="907.0866" stroke="#a5a5a5" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/>
        <text transform="translate(1116.4646 109.62251)" fill="black">
          <tspan font-family="Helvetica Neue" font-weight="bold" font-size="16" fill="black" x="0" y="16">Node B</tspan>
        </text>
      </g>
      <g id="Graphic_138">
        <rect x="468" y="-773" width="566.92914" height="907.0866" stroke="#a5a5a5" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/>
        <text transform="translate(473 109.62251)" fill="black">
          <tspan font-family="Helvetica Neue" font-weight="bold" font-size="16" fill="black" x="0" y="16">Node A</tspan>
        </text>
      </g>
      <g id="Graphic_137">
        <rect x="500.5984" y="-541.9764" width="501.7323" height="565.5118" stroke="#a5a5a5" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/>
        <text transform="translate(505.5984 -.928671)" fill="black">
          <tspan font-family="Helvetica Neue" font-weight="bold" font-size="16" fill="black" x="0" y="16">Pod ztunnel A</tspan>
        </text>
      </g>
      <g id="Graphic_136">
        <rect x="555.874" y="-751.7402" width="391.1811" height="46.771654" fill="#333"/>
        <rect x="555.874" y="-751.7402" width="391.1811" height="46.771654" stroke="gray" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/>
        <text transform="translate(560.874 -738.0864)" fill="white">
          <tspan font-family="Helvetica Neue" font-weight="bold" font-size="16" fill="white" x="137.24655" y="16">Service A Pod</tspan>
        </text>
      </g>
      <g id="Graphic_135">
        <path d="M 555.874 -679.4567 L 947.0551 -679.4567 L 947.0551 -632.68504 L 555.874 -632.68504 Z" stroke="gray" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="4.0,4.0" stroke-width="1"/>
        <text transform="translate(560.874 -675.0269)" fill="black">
          <tspan font-family="Helvetica Neue" font-weight="bold" font-size="16" fill="black" x="50.622546" y="16">iptables chain ztunnel-PREROUTING</tspan>
          <tspan font-family="Helvetica Neue" font-size="16" fill="black" x="123.89455" y="34.46411">mark 0x100/0x100</tspan>
        </text>
      </g>
      <g id="Graphic_134">
        <rect x="555.874" y="-607.1732" width="391.1811" height="46.771654" fill="#dadada"/>
        <rect x="555.874" y="-607.1732" width="391.1811" height="46.771654" stroke="gray" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/>
        <text transform="translate(560.874 -602.74345)" fill="black">
          <tspan font-family="Helvetica Neue" font-weight="bold" font-size="16" fill="black" x="162.01455" y="16">istioout</tspan>
          <tspan font-family="Helvetica Neue" font-size="16" fill="black" x="139.43855" y="34.46411">192.168.127.1</tspan>
        </text>
      </g>
      <g id="Graphic_133">
        <rect x="555.874" y="-526.3858" width="391.1811" height="46.771654" fill="#dadada"/>
        <rect x="555.874" y="-526.3858" width="391.1811" height="46.771654" stroke="gray" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/>
        <text transform="translate(560.874 -521.95605)" fill="black">
          <tspan font-family="Helvetica Neue" font-weight="bold" font-size="16" fill="black" x="157.12655" y="16">pistioout</tspan>
          <tspan font-family="Helvetica Neue" font-size="16" fill="black" x="139.43855" y="34.46411">192.168.127.2</tspan>
        </text>
      </g>
      <g id="Graphic_132">
        <rect x="555.874" y="-454.10236" width="391.1811" height="55.27559" fill="white"/>
        <path d="M 555.874 -454.10236 L 947.0551 -454.10236 L 947.0551 -398.82677 L 555.874 -398.82677 Z" stroke="gray" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="4.0,4.0" stroke-width="1"/>
        <text transform="translate(560.874 -450.5326)" fill="black">
          <tspan font-family="Helvetica Neue" font-weight="bold" font-size="16" fill="black" x="166.58255" y="16">tproxy</tspan>
          <tspan font-family="Helvetica Neue" font-size="12" fill="black" x=".43854565" y="30.46411">-A PREROUTING -i pistioout -p tcp -j TPROXY --on-port 15001 --on-ip </tspan>
          <tspan font-family="Helvetica Neue" font-size="12" fill="black" x="94.75855" y="44.80011">127.0.0.1 --tproxy-mark 0x400/0xfff</tspan>
        </text>
      </g>
      <g id="Graphic_131">
        <rect x="555.874" y="-373.31496" width="391.1811" height="293.38583" fill="white"/>
        <rect x="555.874" y="-373.31496" width="391.1811" height="293.38583" stroke="gray" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/>
        <text transform="translate(560.874 -368.31496)" fill="black">
          <tspan font-family="Helvetica Neue" font-weight="bold" font-size="16" fill="black" x="144.04655" y="16">Envoy proxy</tspan>
          <tspan font-family="Helvetica Neue" font-size="16" fill="black" x="105.81455" y="34.46411">Listening on port 15001</tspan>
        </text>
      </g>
      <g id="Graphic_130">
        <rect x="555.874" y="60.27231" width="391.1811" height="46.771654" fill="#dadada"/>
        <rect x="555.874" y="60.27231" width="391.1811" height="46.771654" stroke="gray" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/>
        <text transform="translate(560.874 64.70208)" fill="black">
          <tspan font-family="Helvetica Neue" font-weight="bold" font-size="16" fill="black" x="157.72655" y="16">Istio CNI</tspan>
          <tspan font-family="Helvetica Neue" font-size="16" fill="black" x="87.46255" y="34.46411">Setup iptables rules for node</tspan>
        </text>
      </g>
      <g id="Line_129">
        <line x1="751.4646" y1="-704.9685" x2="751.4646" y2="-689.3567" marker-end="url(#FilledArrow_Marker)" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/>
      </g>
      <g id="Line_128">
        <line x1="751.4646" y1="-632.68504" x2="751.4646" y2="-617.0732" marker-end="url(#FilledArrow_Marker)" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/>
      </g>
      <g id="Line_127">
        <line x1="751.4646" y1="-560.4016" x2="751.4646" y2="-536.2858" marker-end="url(#FilledArrow_Marker)" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/>
      </g>
      <g id="Line_126">
        <line x1="751.4646" y1="-479.61417" x2="751.4646" y2="-464.00236" marker-end="url(#FilledArrow_Marker)" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/>
      </g>
      <g id="Line_125">
        <line x1="751.4646" y1="-398.82677" x2="751.4646" y2="-383.21496" marker-end="url(#FilledArrow_Marker)" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/>
      </g>
      <g id="Graphic_124">
        <rect x="555.874" y="-61.62827" width="391.1811" height="46.771654" fill="white"/>
        <path d="M 555.874 -61.62827 L 947.0551 -61.62827 L 947.0551 -14.856619 L 555.874 -14.856619 Z" stroke="gray" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="4.0,4.0" stroke-width="1"/>
        <text transform="translate(560.874 -57.1985)" fill="black">
          <tspan font-family="Helvetica Neue" font-weight="bold" font-size="16" fill="black" x="140.53455" y="16">init container</tspan>
          <tspan font-family="Helvetica Neue" font-size="16" fill="black" x="79.76655" y="34.46411">Setup iptables rules for ztunnel</tspan>
        </text>
      </g>
      <g id="Graphic_123">
        <rect x="1146.189" y="-665.9921" width="501.7323" height="502.44095" stroke="#a5a5a5" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/>
        <text transform="translate(1151.189 -188.01529)" fill="black">
          <tspan font-family="Helvetica Neue" font-weight="bold" font-size="16" fill="black" x="0" y="16">Pod ztunnel B</tspan>
        </text>
      </g>
      <g id="Graphic_122">
        <rect x="1199.3386" y="-751.7402" width="391.1811" height="46.771654" fill="#333"/>
        <rect x="1199.3386" y="-751.7402" width="391.1811" height="46.771654" stroke="gray" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/>
        <text transform="translate(1204.3386 -738.0864)" fill="white">
          <tspan font-family="Helvetica Neue" font-weight="bold" font-size="16" fill="white" x="137.09455" y="16">Service B Pod</tspan>
        </text>
      </g>
      <g id="Graphic_121">
        <rect x="1199.3386" y="-23.236214" width="391.1811" height="46.771654" fill="#dadada"/>
        <rect x="1199.3386" y="-23.236214" width="391.1811" height="46.771654" stroke="gray" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/>
        <text transform="translate(1204.3386 -18.806441)" fill="black">
          <tspan font-family="Helvetica Neue" font-weight="bold" font-size="16" fill="black" x="167.65455" y="16">istioin</tspan>
          <tspan font-family="Helvetica Neue" font-size="16" fill="black" x="158.88655" y="34.46411">Pod B IP</tspan>
        </text>
      </g>
      <g id="Graphic_120">
        <rect x="1199.3386" y="-329.37795" width="391.1811" height="46.771654" fill="#dadada"/>
        <rect x="1199.3386" y="-329.37795" width="391.1811" height="46.771654" stroke="gray" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/>
        <text transform="translate(1204.3386 -324.94818)" fill="black">
          <tspan font-family="Helvetica Neue" font-weight="bold" font-size="16" fill="black" x="162.76655" y="16">pistioin</tspan>
          <tspan font-family="Helvetica Neue" font-size="16" fill="black" x="139.43855" y="34.46411">192.168.126.2</tspan>
        </text>
      </g>
      <g id="Graphic_119">
        <rect x="1199.3386" y="-454.10236" width="391.1811" height="88.58268" fill="white"/>
        <path d="M 1199.3386 -454.10236 L 1590.5197 -454.10236 L 1590.5197 -365.5197 L 1199.3386 -365.5197 Z" stroke="gray" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="4.0,4.0" stroke-width="1"/>
        <text transform="translate(1204.3386 -433.8791)" fill="black">
          <tspan font-family="Helvetica Neue" font-weight="bold" font-size="16" fill="black" x="166.58255" y="16">tproxy</tspan>
          <tspan font-family="Helvetica Neue" font-size="12" fill="black" x="4.4405457" y="30.46411">-A PREROUTING -i pistioin -p tcp -j TPROXY --on-port 15006 --on-ip </tspan>
          <tspan font-family="Helvetica Neue" font-size="12" fill="black" x="94.75855" y="44.80011">127.0.0.1 --tproxy-mark 0x400/0xfff</tspan>
        </text>
      </g>
      <g id="Graphic_118">
        <rect x="1199.3386" y="-639.77165" width="391.1811" height="151.65354" fill="white"/>
        <rect x="1199.3386" y="-639.77165" width="391.1811" height="151.65354" stroke="gray" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/>
        <text transform="translate(1204.3386 -634.77165)" fill="black">
          <tspan font-family="Helvetica Neue" font-weight="bold" font-size="16" fill="black" x="144.04655" y="16">Envoy proxy</tspan>
          <tspan font-family="Helvetica Neue" font-size="16" fill="black" x="105.81455" y="34.46411">Listening on port 15008</tspan>
        </text>
      </g>
      <g id="Graphic_117">
        <rect x="1278.7087" y="-532.0551" width="232.44095" height="28.346457" fill="#0a55a8"/>
        <text transform="translate(1283.7087 -527.61394)" fill="white">
          <tspan font-family="Helvetica Neue" font-weight="bold" font-size="16" fill="white" x="15.220474" y="16">Listener ztunnel_inbound</tspan>
        </text>
      </g>
      <g id="Graphic_116">
        <rect x="1278.7087" y="-578.1181" width="232.44095" height="28.346457" fill="#0a55a8"/>
        <text transform="translate(1283.7087 -573.67694)" fill="white">
          <tspan font-family="Helvetica Neue" font-weight="bold" font-size="16" fill="white" x="22.932474" y="16">Cluster virtual_inbound</tspan>
        </text>
      </g>
      <g id="Graphic_115">
        <rect x="1199.3386" y="60.27231" width="391.1811" height="46.771654" fill="#dadada"/>
        <rect x="1199.3386" y="60.27231" width="391.1811" height="46.771654" stroke="gray" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/>
        <text transform="translate(1204.3386 64.70208)" fill="black">
          <tspan font-family="Helvetica Neue" font-weight="bold" font-size="16" fill="black" x="157.72655" y="16">Istio CNI</tspan>
          <tspan font-family="Helvetica Neue" font-size="16" fill="black" x="87.46255" y="34.46411">Setup iptables rules for node</tspan>
        </text>
      </g>
      <g id="Graphic_114">
        <rect x="1199.3386" y="-246.46456" width="391.1811" height="46.771654" fill="white"/>
        <path d="M 1199.3386 -246.46456 L 1590.5197 -246.46456 L 1590.5197 -199.6929 L 1199.3386 -199.6929 Z" stroke="gray" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="4.0,4.0" stroke-width="1"/>
        <text transform="translate(1204.3386 -242.0348)" fill="black">
          <tspan font-family="Helvetica Neue" font-weight="bold" font-size="16" fill="black" x="140.53455" y="16">init container</tspan>
          <tspan font-family="Helvetica Neue" font-size="16" fill="black" x="79.76655" y="34.46411">Setup iptables rules for ztunnel</tspan>
        </text>
      </g>
      <g id="Line_113">
        <line x1="751.4646" y1="23.53544" x2="751.4646" y2="50.37231" marker-end="url(#FilledArrow_Marker)" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/>
      </g>
      <g id="Line_112">
        <line x1="947.0551" y1="83.65813" x2="1189.4386" y2="83.65813" marker-end="url(#FilledArrow_Marker)" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/>
      </g>
      <g id="Line_111">
        <line x1="1394.9291" y1="60.27231" x2="1394.9291" y2="33.43544" marker-end="url(#FilledArrow_Marker)" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/>
      </g>
      <g id="Line_110">
        <line x1="1395.049" y1="-23.236214" x2="1395.7172" y2="-153.6513" marker-end="url(#FilledArrow_Marker)" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/>
      </g>
      <g id="Line_109">
        <line x1="1394.9291" y1="-329.37795" x2="1394.9291" y2="-355.6197" marker-end="url(#FilledArrow_Marker)" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/>
      </g>
      <g id="Line_108">
        <line x1="1394.9291" y1="-454.10236" x2="1394.9291" y2="-478.2181" marker-end="url(#FilledArrow_Marker)" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/>
      </g>
      <g id="Line_107">
        <line x1="1394.9291" y1="-532.0551" x2="1394.9291" y2="-539.87165" marker-end="url(#FilledArrow_Marker)" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/>
      </g>
      <g id="Line_106">
        <line x1="1395.352" y1="-665.9921" x2="1395.1548" y2="-695.0687" marker-end="url(#FilledArrow_Marker)" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/>
      </g>
      <g id="Graphic_105">
        <rect x="1037.6564" y="60.147965" width="70.752" height="46.895996" fill="white"/>
        <text transform="translate(1042.6564 65.147965)" fill="black">
          <tspan font-family="Helvetica Neue" font-size="16" fill="black" x="10.232" y="15">HTTP</tspan>
          <tspan font-family="Helvetica Neue" font-size="16" fill="black" x="20250468e-20" y="33.448">Connect</tspan>
        </text>
      </g>
      <g id="Graphic_104">
        <rect x="635.2441" y="-320.16535" width="232.44095" height="28.346457" fill="#0a55a8"/>
        <text transform="translate(640.2441 -315.72418)" fill="white">
          <tspan font-family="Helvetica Neue" font-weight="bold" font-size="16" fill="white" x="9.580474" y="16">Listener ztunnel_outbound</tspan>
        </text>
      </g>
      <g id="Graphic_103">
        <rect x="635.2441" y="-247.28675" width="232.44095" height="28.346457" fill="#0a55a8"/>
        <text transform="translate(640.2441 -242.84558)" fill="white">
          <tspan font-family="Helvetica Neue" font-weight="bold" font-size="16" fill="white" x="44.356474" y="16">Cluster spiffe://…</tspan>
        </text>
      </g>
      <g id="Graphic_102">
        <rect x="635.2441" y="-183.45046" width="232.44095" height="28.346457" fill="#0a55a8"/>
        <text transform="translate(640.2441 -175.93677)" fill="white">
          <tspan font-family="Helvetica Neue" font-weight="bold" font-size="11" fill="white" x="7.407974" y="11">Listener outbound_tunnel_lis_spiffe://…</tspan>
        </text>
      </g>
      <g id="Line_101">
        <line x1="751.4646" y1="-291.8189" x2="751.4646" y2="-257.18675" marker-end="url(#FilledArrow_Marker)" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/>
      </g>
      <g id="Graphic_100">
        <rect x="627.0306" y="-287.59405" width="243.07087" height="24.335999" fill="white"/>
        <text transform="translate(632.0306 -282.59405)" fill="black">
          <tspan font-family="Helvetica Neue" font-size="12" fill="black" x="7.173431" y="11">Match the destination port and cluster IP</tspan>
        </text>
      </g>
      <g id="Graphic_99">
        <rect x="635.2441" y="-119.61417" width="232.44095" height="28.346457" fill="#0a55a8"/>
        <text transform="translate(640.2441 -112.10048)" fill="white">
          <tspan font-family="Helvetica Neue" font-weight="bold" font-size="11" fill="white" x="9.750974" y="11">Cluster outbound_tunnel_lis_spiffe://…</tspan>
        </text>
      </g>
      <g id="Line_98">
        <line x1="751.4646" y1="-218.9403" x2="751.4646" y2="-193.35046" marker-end="url(#FilledArrow_Marker)" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/>
      </g>
      <g id="Line_97">
        <line x1="751.4646" y1="-155.104" x2="751.4646" y2="-129.51417" marker-end="url(#FilledArrow_Marker)" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/>
      </g>
    </g>
  </g>
</svg>
